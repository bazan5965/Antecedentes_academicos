<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antecedentes Académicos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .section-hidden {
            display: none;
        }
        .message-container {
            transition: all 0.3s ease-in-out;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            margin-top: 1rem;
        }
        .message-container.visible {
            opacity: 1;
            max-height: 100px;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 relative">

    <div id="main-content" class="container bg-white p-8 rounded-xl shadow-xl w-full max-w-4xl mx-auto border-4" style="border-color: #F4ACB7;">
        <header class="text-center mb-8">
            <h1 class="text-2xl font-bold" style="color: #F4ACB7;">Antecedentes Académicos</h1>
            <p class="mt-2 text-gray-600">Completa la información según la materia que cursas.</p>
        </header>

        <form id="academic-form">
            <section class="p-4 bg-gray-50 rounded-md mb-8 border-l-4" style="border-color: #FB6F92;">
                <h2 class="text-xl font-semibold mb-4" style="color: #FB6F92;">Información Personal</h2>
                <div class="mb-4">
                    <label for="preferred-name" class="block text-sm font-medium text-gray-700">¿Con qué nombre prefieres que me refiera a ti? (Sólo un nombre)</label>
                    <input type="text" id="preferred-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 sm:text-sm p-2" placeholder="Ej. Juan" required oninput="this.value = this.value.replace(/\s/g, '')" pattern="^\S+$">
                </div>
                <div class="mb-4">
                    <label for="student-id" class="block text-sm font-medium text-gray-700">Número de Boleta:</label>
                    <input type="text" id="student-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 sm:text-sm p-2" placeholder="Ej. 2023xxxxxx" minlength="10" maxlength="10" pattern="\d{10}" required oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                </div>
            </section>

            <section class="p-4 bg-gray-50 rounded-md mb-8 border-l-4" style="border-color: #FFCAD4;">
                <h2 class="text-xl font-semibold mb-4" style="color: #FFCAD4;">Selección de Materia</h2>
                <div class="mb-4">
                    <label for="materia-select" class="block text-sm font-medium text-gray-700">Selecciona la materia que cursas:</label>
                    <select id="materia-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 sm:text-sm p-2">
                        <option value="">-- Seleccionar --</option>
                        <option value="calculo-1">Cálculo 1</option>
                        <option value="calculo-2">Cálculo 2</option>
                        <option value="calculo-3">Cálculo 3</option>
                    </select>
                </div>
            </section>

            <section id="travel-time-section" class="section-hidden p-4 bg-gray-50 rounded-md mb-8 border-l-4" style="border-color: #4F518C;">
                <h2 class="text-xl font-semibold mb-4" style="color: #4F518C;">Tiempos de Traslado</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tiempo de traslado casa-escuela:</label>
                        <div class="flex items-center mt-1">
                            <input type="text" id="home-to-school-hours" class="w-1/2 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 sm:text-sm p-2" min="0" placeholder="Horas" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                            <span class="mx-2 text-gray-600">h</span>
                            <input type="text" id="home-to-school-minutes" class="w-1/2 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 sm:text-sm p-2" min="0" max="59" placeholder="Minutos" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                            <span class="mx-2 text-gray-600">m</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tiempo de traslado escuela-casa:</label>
                        <div class="flex items-center mt-1">
                            <input type="text" id="school-to-home-hours" class="w-1/2 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 sm:text-sm p-2" min="0" placeholder="Horas" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                            <span class="mx-2 text-gray-600">h</span>
                            <input type="text" id="school-to-home-minutes" class="w-1/2 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 sm:text-sm p-2" min="0" max="59" placeholder="Minutos" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                            <span class="mx-2 text-gray-600">m</span>
                        </div>
                    </div>
                </div>
                <div class="mt-6 p-4 bg-gray-100 rounded-md text-center">
                    <h4 class="text-md font-semibold text-gray-600">Tiempo Total de Traslado:</h4>
                    <p id="total-travel-time" class="text-3xl font-bold" style="color: #4F518C;">0h 0m</p>
                </div>
            </section>

            <section id="indicators-section" class="section-hidden p-4 bg-gray-50 rounded-md mb-8 border-l-4" style="border-color: #62BFED;">
                <h2 class="text-xl font-semibold mb-4" style="color: #62BFED;">Indicadores Académicos</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="accredited-credits" class="block text-sm font-medium text-gray-700">
                            Número de créditos acreditados:
                        </label>
                        <input type="text" id="accredited-credits" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 sm:text-sm p-2" min="0" required oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                    </div>
                    <div>
                        <label for="accredited-materias" class="block text-sm font-medium text-gray-700">
                            Número de unidades de aprendizaje acreditadas:
                        </label>
                        <input type="text" id="accredited-materias" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 sm:text-sm p-2" min="0" required oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                    </div>
                    <div>
                        <label for="school-periods" class="block text-sm font-medium text-gray-700">
                            Cantidad de periodos escolares cursados:
                        </label>
                        <input type="text" id="school-periods" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 sm:text-sm p-2" min="1" required oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                    </div>
                    <div>
                        <label for="average-grade" class="block text-sm font-medium text-gray-700">
                            Promedio de <strong>materias acreditadas</strong>:
                        </label>
                        <input type="text" id="average-grade" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 sm:text-sm p-2" min="6.0" step="0.01" placeholder="Ej. 8.5" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');">
                        <div id="average-grade-error" class="text-red-600 text-sm mt-1 hidden">El promedio no puede ser menor a 6.0.</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                    <div class="p-4 bg-gray-100 rounded-md text-center">
                        <h4 class="text-md font-semibold text-gray-600">Indicador de Avance:</h4>
                        <p id="indicador-output" class="text-3xl font-bold" style="color: #62BFED;">N/A</p>
                    </div>
                    <div class="p-4 bg-gray-100 rounded-md text-center">
                        <h4 class="text-md font-semibold text-gray-600">Velocidad de Avance:</h4>
                        <p id="velocidad-output" class="text-3xl font-bold" style="color: #62BFED;">N/A</p>
                    </div>
                </div>
            </section>

            <section id="tables-section" class="section-hidden p-4 bg-gray-50 rounded-md mb-8 border-l-4" style="border-color: #F4ACB7;">
                <h2 class="text-xl font-semibold mb-4" style="color: #F4ACB7;">Unidades de Aprendizaje</h2>
                <div class="space-y-6">
                    <div>
                        <label for="reprobadas-no-inscribir" class="block text-sm font-medium text-gray-700">Número de unidades reprobadas, que NO va a inscribir:</label>
                        <input type="text" id="reprobadas-no-inscribir" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 sm:text-sm p-2" min="0" value="0" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                    </div>
                    <div>
                        <label for="reprobadas-si-inscribir" class="block text-sm font-medium text-gray-700">Número de unidades reprobadas, que SÍ va a inscribir:</label>
                        <input type="text" id="reprobadas-si-inscribir" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 sm:text-sm p-2" min="0" value="0" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                    </div>
                    <div>
                        <label for="por-primera-vez" class="block text-sm font-medium text-gray-700">Número de unidades a inscribir por primera vez:</label>
                        <input type="text" id="por-primera-vez" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 sm:text-sm p-2" min="0" value="0" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                    </div>
                </div>
            </section>
            
            <div class="text-center mt-8 no-print flex justify-center">
                <button type="button" id="submit-btn" class="w-full md:w-auto px-6 py-2 rounded-lg text-white font-semibold transition-all duration-300 transform hover:scale-105" style="background-color: #F4ACB7;">
                    Enviar Datos
                </button>
            </div>
            
            <div id="feedback-message" class="message-container bg-white p-3 rounded-md text-sm text-center font-medium"></div>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Paleta de colores para los acentos
        const accentColors = ['#F4ACB7', '#FB6F92', '#FFCAD4', '#4F518C', '#62BFED'];
        let colorIndex = 0;
        function getNextColor() {
            const color = accentColors[colorIndex];
            colorIndex = (colorIndex + 1) % accentColors.length;
            return color;
        }

        // Aplicar colores de acento a los elementos
        function applyAccentColors() {
            // El `main-content` border color, el botón y el título principal usan el primer color
            const mainContainer = document.getElementById('main-content');
            const mainTitle = document.querySelector('h1');
            const submitBtn = document.getElementById('submit-btn');
            
            mainContainer.style.borderColor = accentColors[0];
            if (mainTitle) { mainTitle.style.color = accentColors[0]; }
            if (submitBtn) { submitBtn.style.backgroundColor = accentColors[0]; }

            // Las secciones y sus títulos usan los colores restantes en orden
            const sections = document.querySelectorAll('section');
            sections.forEach((section, index) => {
                const color = accentColors[index + 1] || accentColors[0];
                section.style.borderColor = color;
                const title = section.querySelector('h2');
                if (title) {
                    title.style.color = color;
                }
            });

            // Los outputs de tiempo de traslado e indicadores usan los últimos colores
            const totalTravelTimeOutput = document.getElementById('total-travel-time');
            if (totalTravelTimeOutput) {
                totalTravelTimeOutput.style.color = accentColors[3];
            }
            
            const indicadorOutput = document.getElementById('indicador-output');
            const velocidadOutput = document.getElementById('velocidad-output');
            if (indicadorOutput && velocidadOutput) {
                indicadorOutput.style.color = accentColors[4];
                velocidadOutput.style.color = accentColors[4];
            }
        }

        // Llamar a la función al cargar la página
        window.onload = applyAccentColors;

        // Variables globales de Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Datos del programa académico "Tronco común de la L.F. y M."
        const troncoComunData = {
            creditosTotales: 312,
            semestresTotales: 12
        };

        // Elementos del DOM
        const materiaSelect = document.getElementById('materia-select');
        const travelSection = document.getElementById('travel-time-section');
        const indicatorsSection = document.getElementById('indicators-section');
        const tablesSection = document.getElementById('tables-section');
        const submitBtn = document.getElementById('submit-btn');
        const feedbackMessageDiv = document.getElementById('feedback-message');
        const preferredNameInput = document.getElementById('preferred-name');
        const studentIdInput = document.getElementById('student-id');
        const averageGradeInput = document.getElementById('average-grade');
        const averageGradeError = document.getElementById('average-grade-error');
        const homeToSchoolHoursInput = document.getElementById('home-to-school-hours');
        const homeToSchoolMinutesInput = document.getElementById('home-to-school-minutes');
        const schoolToHomeHoursInput = document.getElementById('school-to-home-hours');
        const schoolToHomeMinutesInput = document.getElementById('school-to-home-minutes');
        const totalTravelTimeOutput = document.getElementById('total-travel-time');
        const reprobadasNoInscribirInput = document.getElementById('reprobadas-no-inscribir');
        const reprobadasSiInscribirInput = document.getElementById('reprobadas-si-inscribir');
        const porPrimeraVezInput = document.getElementById('por-primera-vez');
        const indicadorOutput = document.getElementById('indicador-output');
        const velocidadOutput = document.getElementById('velocidad-output');
        const accreditedCreditsInput = document.getElementById('accredited-credits');
        const accreditedMateriasInput = document.getElementById('accredited-materias');
        const schoolPeriodsInput = document.getElementById('school-periods');

        // Función para mostrar mensajes de estado
        function showFeedback(message, isSuccess = false) {
            feedbackMessageDiv.textContent = message;
            feedbackMessageDiv.classList.add('visible');
            if (isSuccess) {
                feedbackMessageDiv.classList.remove('text-red-600', 'bg-white');
                feedbackMessageDiv.classList.add('bg-green-100', 'text-green-800');
            } else {
                feedbackMessageDiv.classList.remove('bg-green-100', 'text-green-800');
                feedbackMessageDiv.classList.add('bg-red-100', 'text-red-800');
            }
            setTimeout(() => {
                feedbackMessageDiv.classList.remove('visible');
            }, 5000);
        }

        // Función de autenticación de Firebase
        async function authenticate() {
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                const userId = auth.currentUser.uid;
                loadData(db, userId);
                console.log('Autenticación exitosa.');
            } catch (error) {
                console.error("Error al autenticar:", error);
                showFeedback("Error de autenticación: Por favor, intente recargar la página.", false);
            }
        }

        // Función para cargar los datos del usuario desde Firestore
        async function loadData(db, userId) {
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'academic_form_data', 'my_form');
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    preferredNameInput.value = data.preferredName || '';
                    studentIdInput.value = data.studentId || '';
                    materiaSelect.value = data.materia || '';
                    
                    homeToSchoolHoursInput.value = data.travelTime?.homeToSchoolHours || '';
                    homeToSchoolMinutesInput.value = data.travelTime?.homeToSchoolMinutes || '';
                    schoolToHomeHoursInput.value = data.travelTime?.schoolToHomeHours || '';
                    schoolToHomeMinutesInput.value = data.travelTime?.schoolToHomeMinutes || '';
                    calculateTravelTime();
                    
                    if (data.materia === 'calculo-2' || data.materia === 'calculo-3') {
                        accreditedCreditsInput.value = data.accreditedCredits || '';
                        accreditedMateriasInput.value = data.accreditedMaterias || '';
                        schoolPeriodsInput.value = data.schoolPeriods || '';
                        averageGradeInput.value = data.averageGrade || '';
                        reprobadasNoInscribirInput.value = data.materiasCount?.reprobadasNoInscribir || '';
                        reprobadasSiInscribirInput.value = data.materiasCount?.reprobadasSiInscribir || '';
                        porPrimeraVezInput.value = data.materiasCount?.porPrimeraVez || '';
                        calculateOldIndicators();
                        validateAverageGrade();
                    }
                    updateFormVisibility(data.materia);
                    console.log("Datos cargados exitosamente desde Firestore.");
                }
            } catch (error) {
                console.error("Error al cargar datos:", error);
            }
        }

        // Muestra u oculta secciones del formulario
        function updateFormVisibility(materia) {
            travelSection.classList.add('section-hidden');
            indicatorsSection.classList.add('section-hidden');
            tablesSection.classList.add('section-hidden');

            if (materia) {
                travelSection.classList.remove('section-hidden');
            }

            if (materia === 'calculo-2' || materia === 'calculo-3') {
                indicatorsSection.classList.remove('section-hidden');
                tablesSection.classList.remove('section-hidden');
            }
        }

        // Calcula el tiempo total de traslado
        function calculateTravelTime() {
            const h1 = parseInt(homeToSchoolHoursInput.value) || 0;
            const m1 = parseInt(homeToSchoolMinutesInput.value) || 0;
            const h2 = parseInt(schoolToHomeHoursInput.value) || 0;
            const m2 = parseInt(schoolToHomeMinutesInput.value) || 0;

            let totalMinutes = (h1 + h2) * 60 + (m1 + m2);
            let finalHours = Math.floor(totalMinutes / 60);
            let finalMinutes = totalMinutes % 60;
            
            totalTravelTimeOutput.textContent = `${finalHours}h ${finalMinutes}m`;
        }
        
        // Calcula los indicadores de Avance y Velocidad
        function calculateOldIndicators() {
            const accreditedCredits = parseFloat(accreditedCreditsInput.value) || 0;
            const accreditedMaterias = parseFloat(accreditedMateriasInput.value) || 0;
            const schoolPeriods = parseFloat(schoolPeriodsInput.value) || 0;
            
            const totalProgramCredits = troncoComunData.creditosTotales;
            const totalProgramSemesters = troncoComunData.semestresTotales;
            
            // Calculo de Velocidad
            if (schoolPeriods > 0) {
                const velocidad = accreditedMaterias / schoolPeriods;
                velocidadOutput.textContent = velocidad.toFixed(2);
            } else {
                velocidadOutput.textContent = "N/A";
            }

            // Calculo de Indicador
            if (totalProgramSemesters > schoolPeriods && totalProgramSemesters > 0) {
                const remainingCredits = totalProgramCredits - accreditedCredits;
                const remainingSemesters = totalProgramSemesters - schoolPeriods;
                
                if (remainingSemesters > 0) {
                    const indicador = remainingCredits / remainingSemesters;
                    indicadorOutput.textContent = indicador.toFixed(2);
                } else {
                    indicadorOutput.textContent = "N/A";
                }
            } else {
                indicadorOutput.textContent = "N/A";
            }
        }

        // Valida el promedio
        function validateAverageGrade() {
            const grade = parseFloat(averageGradeInput.value);
            if (isNaN(grade) || grade < 6.0) {
                averageGradeError.classList.remove('hidden');
            } else {
                averageGradeError.classList.add('hidden');
            }
        }

        // Event Listeners
        materiaSelect.addEventListener('change', (e) => {
            updateFormVisibility(e.target.value);
        });

        const travelTimeInputs = [homeToSchoolHoursInput, homeToSchoolMinutesInput, schoolToHomeHoursInput, schoolToHomeMinutesInput];
        travelTimeInputs.forEach(input => {
            input.addEventListener('input', calculateTravelTime);
        });
        
        const oldIndicatorInputs = [accreditedCreditsInput, accreditedMateriasInput, schoolPeriodsInput];
        oldIndicatorInputs.forEach(input => {
            input.addEventListener('input', calculateOldIndicators);
        });

        averageGradeInput.addEventListener('input', validateAverageGrade);

        submitBtn.addEventListener('click', async () => {
            const selectedMateria = materiaSelect.value;
            const studentId = studentIdInput.value;

            // Validación de Boleta
            if (!/^\d{10}$/.test(studentId)) {
                showFeedback("El número de boleta debe contener exactamente 10 dígitos.", false);
                return;
            }

            // Validación del nombre de una sola palabra
            if (/\s/.test(preferredNameInput.value)) {
                showFeedback("Por favor, ingrese solo una palabra en el nombre.", false);
                return;
            }

            // Validaciones básicas
            if (!preferredNameInput.value || !studentId || !selectedMateria) {
                showFeedback("Por favor, complete los campos básicos.", false);
                return;
            }
            
            // Obtener los valores de tiempo de traslado y formatearlos
            const homeToSchoolFormatted = `${parseInt(homeToSchoolHoursInput.value) || 0}h ${parseInt(homeToSchoolMinutesInput.value) || 0}m`;
            const schoolToHomeFormatted = `${parseInt(schoolToHomeHoursInput.value) || 0}h ${parseInt(schoolToHomeMinutesInput.value) || 0}m`;
            const totalTravelMinutes = ((parseInt(homeToSchoolHoursInput.value) || 0) + (parseInt(schoolToHomeHoursInput.value) || 0)) * 60 + ((parseInt(homeToSchoolMinutesInput.value) || 0) + (parseInt(schoolToHomeMinutesInput.value) || 0));
            const totalTravelHoursFormatted = Math.floor(totalTravelMinutes / 60);
            const totalTravelMinutesFormatted = totalTravelMinutes % 60;

            let dataToSave = {
                preferredName: preferredNameInput.value,
                studentId: studentId,
                materia: selectedMateria,
                travelTime: {
                    homeToSchoolFormatted: homeToSchoolFormatted,
                    schoolToHomeFormatted: schoolToHomeFormatted,
                    totalTravelFormatted: `${totalTravelHoursFormatted}h ${totalTravelMinutesFormatted}m`
                }
            };

            if (selectedMateria === 'calculo-2' || selectedMateria === 'calculo-3') {
                const accreditedCredits = parseInt(accreditedCreditsInput.value) || 0;
                const accreditedMaterias = parseInt(accreditedMateriasInput.value) || 0;
                const schoolPeriods = parseInt(schoolPeriodsInput.value) || 0;
                const grade = parseFloat(averageGradeInput.value);

                // Validaciones para indicadores académicos
                if (isNaN(accreditedCredits) || accreditedCredits < 0) {
                    showFeedback("Por favor, ingrese un número de créditos acreditados válido (entero positivo).", false);
                    return;
                }
                if (isNaN(accreditedMaterias) || accreditedMaterias < 0) {
                    showFeedback("Por favor, ingrese un número de unidades acreditadas válido (entero positivo).", false);
                    return;
                }
                if (isNaN(schoolPeriods) || schoolPeriods < 1) {
                    showFeedback("Por favor, ingrese una cantidad de periodos escolares válida (entero positivo).", false);
                    return;
                }
                if (isNaN(grade) || grade < 6.0) {
                    showFeedback("Por favor, ingrese un promedio válido (6.0 o mayor).", false);
                    return;
                }


                const totalProgramCredits = troncoComunData.creditosTotales;
                const totalProgramSemesters = troncoComunData.semestresTotales;
                const remainingCredits = totalProgramCredits - accreditedCredits;
                const remainingSemesters = totalProgramSemesters - schoolPeriods;
                const indicador = remainingSemesters > 0 ? (remainingCredits / remainingSemesters) : 0;
                const velocidad = schoolPeriods > 0 ? (accreditedMaterias / schoolPeriods) : 0;

                Object.assign(dataToSave, {
                    accreditedCredits: accreditedCredits,
                    accreditedMaterias: accreditedMaterias,
                    schoolPeriods: schoolPeriods,
                    averageGrade: grade,
                    indicador: indicador,
                    velocidad: velocidad,
                    materiasCount: {
                        reprobadasNoInscribir: parseInt(reprobadasNoInscribirInput.value) || 0,
                        reprobadasSiInscribir: parseInt(reprobadasSiInscribirInput.value) || 0,
                        porPrimeraVez: parseInt(porPrimeraVezInput.value) || 0,
                    }
                });
            }

            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbygFq-qRp2CJSLBLl7uTgp9-lISHI_0lk_6t9Q9Pd1cm9tGZL11qrgg3orrHMzEMvo/exec'; 

            showFeedback("Enviando datos...", false);
            try {
                // The `mode: 'no-cors'` is crucial here to prevent the browser's security
                // policies from blocking the cross-origin request. This is the fix for the
                // `Failed to fetch` error.
                // Note: with `no-cors`, the response is "opaque" and cannot be inspected.
                // We assume success if the network request completes without an error.
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(dataToSave),
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'no-cors'
                });
                
                // Since the response is opaque, we cannot check `response.ok` or parse
                // `response.json()`. If we reach this point without an error, the request
                // was sent successfully.
                showFeedback("✅ Datos enviados y guardados correctamente en Google Sheets!", true);
                
            } catch (error) {
                // This catch block will only be triggered for a true network error,
                // like a domain not found, not a CORS error.
                showFeedback("Hubo un error al enviar los datos. Por favor, revisa tu conexión a Internet.", false);
                console.error('Error al enviar datos:', error);
            }
        });
        
        // Iniciar la autenticación al cargar la página
        authenticate();
    </script>
</body>
</html>
